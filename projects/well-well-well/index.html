<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Well Well Well | Team T. Team </title> <meta name="author" content="Team T. Team"> <meta name="description" content="425 points"> <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website"> <link rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="/govtech-25-ctf-writeup/assets/libs/mdb/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="/govtech-25-ctf-writeup/assets/libs/google_fonts/google-fonts.css"> <link defer rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/govtech-25-ctf-writeup/assets/img/team-team-logo.png?515ee9a93529f322a89c3b07c0a510dc"> <link rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://cakiki.github.io/govtech-25-ctf-writeup/projects/well-well-well/"> <script src="/govtech-25-ctf-writeup/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/govtech-25-ctf-writeup/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/govtech-25-ctf-writeup/"> <span class="font-weight-bold">Team</span> T. Team </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/govtech-25-ctf-writeup/">Home </a> </li> <li class="nav-item "> <a class="nav-link" href="/govtech-25-ctf-writeup/writeups/">Writeups </a> </li> <li class="nav-item "> <a class="nav-link" href="/govtech-25-ctf-writeup/team/">Team </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Well Well Well</h1> <p class="post-description">425 points</p> </header> <article> <blockquote class="block-tip"> <h4 id="challenge">Challenge</h4> <p>Hmm, I think there is a way to make me the Best Hedgehog ever! Help me do it, and I’ll reward you generously! ~ Jaga, the Cybersecurity Hedgehog You seem to have found yourself at the bottom of an old well, with no obvious way to get out. The only thing you can find on the ground is a pile of bones next to a dusty old personal assistant device. You don’t see its owner anywhere, so surely they managed to escape.</p> <p>You try scraping the device for clues, but almost everything is encrypted. The only usable artefact left behind came from the model’s internals, a cache of some sort. You hope this is enough to get somewhere.</p> </blockquote> <h4 id="solution">Solution</h4> <p>We run a greedy brute force search across each token, at each position ID, to find the token which produces past_key_values that are the closest to the keys at that position in the KV cache we’ve been given.</p> <p>We use as large a batch size as possible when searching over tokens to reduce the time taken.</p> <figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-table"><tbody><tr>
<td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
</pre></td> <td class="code"><pre><span class="kn">import</span> <span class="n">torch</span>
<span class="kn">from</span> <span class="n">transformers</span> <span class="kn">import</span> <span class="n">AutoTokenizer</span><span class="p">,</span> <span class="n">AutoModelForCausalLM</span>

<span class="n">PATH_CACHE</span> <span class="o">=</span> <span class="sh">"</span><span class="s">./kv_cache.pt</span><span class="sh">"</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">device</span><span class="p">(</span><span class="sh">"</span><span class="s">cuda</span><span class="sh">"</span><span class="p">)</span>
<span class="n">DTYPE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">float32</span>

<span class="nd">@torch.no_grad</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">solve</span><span class="p">():</span>
    <span class="n">kv_cache</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">load</span><span class="p">(</span><span class="n">PATH_CACHE</span><span class="p">,</span> <span class="n">map_location</span><span class="o">=</span><span class="n">DEVICE</span><span class="p">)</span>
    <span class="n">K_rot</span> <span class="o">=</span> <span class="n">kv_cache</span><span class="p">[</span><span class="sh">"</span><span class="s">K_rot</span><span class="sh">"</span><span class="p">].</span><span class="nf">to</span><span class="p">(</span><span class="n">DTYPE</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">kv_cache</span><span class="p">[</span><span class="sh">"</span><span class="s">T</span><span class="sh">"</span><span class="p">])</span>
    <span class="n">ckpt</span> <span class="o">=</span> <span class="n">kv_cache</span><span class="p">[</span><span class="sh">"</span><span class="s">model</span><span class="sh">"</span><span class="p">]</span>
    <span class="n">rev</span> <span class="o">=</span> <span class="n">kv_cache</span><span class="p">[</span><span class="sh">"</span><span class="s">revision</span><span class="sh">"</span><span class="p">]</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">AutoModelForCausalLM</span><span class="p">.</span><span class="nf">from_pretrained</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">rev</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">).</span><span class="nf">eval</span><span class="p">()</span>
    <span class="n">tok</span> <span class="o">=</span> <span class="n">AutoTokenizer</span><span class="p">.</span><span class="nf">from_pretrained</span><span class="p">(</span><span class="n">ckpt</span><span class="p">,</span> <span class="n">revision</span><span class="o">=</span><span class="n">rev</span><span class="p">,</span> <span class="n">use_fast</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">special_ids</span> <span class="o">=</span> <span class="nf">set</span><span class="p">(</span><span class="n">tok</span><span class="p">.</span><span class="n">all_special_ids</span> <span class="ow">or</span> <span class="p">[])</span>
    <span class="n">cand_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">tensor</span><span class="p">(</span>
        <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">tok</span><span class="p">.</span><span class="n">vocab_size</span><span class="p">)</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">special_ids</span><span class="p">],</span>
        <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="p">.</span><span class="nb">long</span>
    <span class="p">)</span>

    <span class="n">B</span> <span class="o">=</span> <span class="mi">6144</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">T</span><span class="p">):</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">K_rot</span><span class="p">[:,</span><span class="n">t</span><span class="p">,:].</span><span class="nf">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">best_err</span> <span class="o">=</span> <span class="mf">1e20</span>
        <span class="n">best_id</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">for</span> <span class="n">start</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">cand_ids</span><span class="p">),</span> <span class="n">B</span><span class="p">):</span>
            <span class="n">batch_ids</span> <span class="o">=</span> <span class="n">cand_ids</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">start</span><span class="o">+</span><span class="n">B</span><span class="p">]</span>
            
            <span class="n">input_ids</span> <span class="o">=</span> <span class="n">batch_ids</span><span class="p">.</span><span class="nf">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">).</span><span class="nf">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">position_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nf">full_like</span><span class="p">(</span><span class="n">input_ids</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
            <span class="n">outputs</span> <span class="o">=</span> <span class="nf">model</span><span class="p">(</span>
                <span class="n">input_ids</span><span class="o">=</span><span class="n">input_ids</span><span class="p">,</span>
                <span class="n">use_cache</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                <span class="n">position_ids</span><span class="o">=</span><span class="n">position_ids</span><span class="p">,</span>
                <span class="n">return_dict</span><span class="o">=</span><span class="bp">True</span>
            <span class="p">)</span>
            <span class="n">k0</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">.</span><span class="n">past_key_values</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">k_batch</span> <span class="o">=</span> <span class="n">k0</span><span class="p">.</span><span class="nf">squeeze</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="nf">contiguous</span><span class="p">().</span><span class="nf">to</span><span class="p">(</span><span class="n">DTYPE</span><span class="p">)</span>
            
            <span class="n">diffs</span> <span class="o">=</span> <span class="n">k_batch</span> <span class="o">-</span> <span class="n">target</span>
            <span class="n">errs</span> <span class="o">=</span> <span class="p">(</span><span class="n">diffs</span> <span class="o">*</span> <span class="n">diffs</span><span class="p">).</span><span class="nf">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">min_err</span><span class="p">,</span> <span class="n">min_idx</span> <span class="o">=</span> <span class="n">errs</span><span class="p">.</span><span class="nf">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_err</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">:</span>
                <span class="n">best_err</span> <span class="o">=</span> <span class="nf">float</span><span class="p">(</span><span class="n">min_err</span><span class="p">)</span>
                <span class="n">best_id</span> <span class="o">=</span> <span class="nf">int</span><span class="p">(</span><span class="n">batch_ids</span><span class="p">[</span><span class="n">min_idx</span><span class="p">])</span>

        <span class="n">result</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">best_id</span><span class="p">)</span>
        <span class="nf">print</span><span class="p">(</span><span class="n">tok</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>
    
    <span class="nf">print</span><span class="p">()</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">tok</span><span class="p">.</span><span class="nf">decode</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">clean_up_tokenization_spaces</span><span class="o">=</span><span class="bp">False</span><span class="p">))</span>

<span class="nf">solve</span><span class="p">()</span>
</pre></td> </tr></tbody></table></code></pre></figure> <figure> <picture> <source class="responsive-img-srcset" srcset="/govtech-25-ctf-writeup/assets/img/wellwellwell-480.webp 480w,/govtech-25-ctf-writeup/assets/img/wellwellwell-800.webp 800w,/govtech-25-ctf-writeup/assets/img/wellwellwell-1400.webp 1400w," type="image/webp" sizes="95vw"></source> <img src="/govtech-25-ctf-writeup/assets/img/wellwellwell.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Team T. Team. Using <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a>. </div> </footer> <script src="/govtech-25-ctf-writeup/assets/libs/jquery/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/govtech-25-ctf-writeup/assets/js/bootstrap.bundle.min.js"></script> <script src="/govtech-25-ctf-writeup/assets/libs/mdb/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="/govtech-25-ctf-writeup/assets/libs/masonry/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="/govtech-25-ctf-writeup/assets/libs/imagesloaded/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="/govtech-25-ctf-writeup/assets/libs/medium_zoom/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/govtech-25-ctf-writeup/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="/govtech-25-ctf-writeup/assets/libs/mathjax/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/govtech-25-ctf-writeup/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="/govtech-25-ctf-writeup/assets/libs/polyfill/polyfill.min.js" crossorigin="anonymous"></script> <script defer src="/govtech-25-ctf-writeup/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/govtech-25-ctf-writeup/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> </body> </html>